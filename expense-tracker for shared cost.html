<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>ExpenseSync - Expense Tracker</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      :root {
        --primary-custom: hsl(220, 100%, 50%);
        --primary-dark: hsl(220, 100%, 40%);
        --text-primary: hsl(0, 0%, 20%);
        --text-secondary: hsl(0, 0%, 50%);
        --surface: hsl(0, 0%, 98%);
      }

      .bg-primary-custom { background-color: var(--primary-custom); }
      .hover\\:bg-primary-dark:hover { background-color: var(--primary-dark); }
      .text-primary-custom { color: var(--primary-custom); }
      .text-text-primary { color: var(--text-primary); }
      .text-text-secondary { color: var(--text-secondary); }
      .bg-surface { background-color: var(--surface); }
      .hover\\:bg-surface:hover { background-color: var(--surface); }

      .file-upload-area {
        border: 2px dashed #e5e7eb;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }

      .file-upload-area:hover {
        border-color: var(--primary-custom);
        background-color: var(--surface);
      }

      .file-upload-area.dragover {
        border-color: var(--primary-custom);
        background-color: var(--surface);
      }

      .transaction-table {
        min-width: 100%;
        border-collapse: collapse;
      }

      .transaction-table th,
      .transaction-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .transaction-table th {
        background-color: var(--surface);
        font-weight: 500;
        color: var(--text-secondary);
      }

      .transaction-table tbody tr:hover {
        background-color: var(--surface);
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-primary {
        background-color: var(--primary-custom);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-secondary {
        background-color: white;
        color: var(--text-secondary);
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover {
        background-color: var(--surface);
      }

      .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-custom);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .step-indicator {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .step-number {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        font-size: 0.875rem;
      }

      .step.active .step-number {
        background-color: var(--primary-custom);
        color: white;
      }

      .step:not(.active) .step-number {
        background-color: #d1d5db;
        color: var(--text-secondary);
      }

      .step.active .step-label {
        color: var(--primary-custom);
      }

      .step:not(.active) .step-label {
        color: var(--text-secondary);
      }

      .hidden { display: none; }
      .block { display: block; }
      .flex { display: flex; }
      .grid { display: grid; }
      .w-full { width: 100%; }
      .h-full { height: 100%; }
      .min-h-screen { min-height: 100vh; }
      .max-w-6xl { max-width: 72rem; }
      .mx-auto { margin-left: auto; margin-right: auto; }
      .px-4 { padding-left: 1rem; padding-right: 1rem; }
      .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
      .mb-6 { margin-bottom: 1.5rem; }
      .mt-4 { margin-top: 1rem; }
      .space-x-3 > * + * { margin-left: 0.75rem; }
      .items-center { align-items: center; }
      .justify-between { justify-content: space-between; }
      .rounded-lg { border-radius: 0.5rem; }
      .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
      .border { border-width: 1px; }
      .border-gray-200 { border-color: #e5e7eb; }
      .text-xl { font-size: 1.25rem; }
      .text-lg { font-size: 1.125rem; }
      .text-sm { font-size: 0.875rem; }
      .font-medium { font-weight: 500; }
      .h-16 { height: 4rem; }
      .h-5 { height: 1.25rem; }
      .w-5 { width: 1.25rem; }
      .w-8 { width: 2rem; }
      .h-8 { height: 2rem; }
      .p-6 { padding: 1.5rem; }
      .overflow-x-auto { overflow-x: auto; }
    </style>
  </head>
  <body class="min-h-screen" style="background-color: var(--surface);">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-primary-custom rounded-lg flex items-center justify-center">
              <i data-lucide="dollar-sign" class="h-5 w-5 text-white"></i>
            </div>
            <h1 class="text-xl font-medium text-text-primary">ExpenseSync</h1>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- Progress Stepper -->
      <div class="step-indicator">
        <div class="step active" id="step-1">
          <div class="step-number">1</div>
          <span class="step-label text-sm font-medium">Upload Statement</span>
        </div>
        <div class="step" id="step-2">
          <div class="step-number">2</div>
          <span class="step-label text-sm font-medium">Select Transactions</span>
        </div>
        <div class="step" id="step-3">
          <div class="step-number">3</div>
          <span class="step-label text-sm font-medium">Export to Excel</span>
        </div>
        <div class="step" id="step-4">
          <div class="step-number">4</div>
          <span class="step-label text-sm font-medium">Complete</span>
        </div>
      </div>

      <!-- Step 1: Upload -->
      <div id="upload-section" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center space-x-3 mb-4">
          <i data-lucide="upload" class="h-5 w-5 text-primary-custom"></i>
          <h2 class="text-lg font-medium text-text-primary">Upload Financial Statement</h2>
        </div>
        <div class="file-upload-area" id="file-upload-area">
          <input type="file" id="file-input" accept=".csv,.xlsx,.xls,.pdf" style="display: none;">
          <i data-lucide="upload-cloud" class="h-12 w-12 mx-auto mb-4 text-gray-400"></i>
          <p class="text-text-primary font-medium mb-2">Drop your file here or click to browse</p>
          <p class="text-text-secondary text-sm">Supports CSV, Excel, and PDF files</p>
        </div>
      </div>

      <!-- Step 2: Transaction Selection -->
      <div id="transaction-section" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <i data-lucide="list" class="h-5 w-5 text-primary-custom"></i>
            <h2 class="text-lg font-medium text-text-primary">Select Transactions</h2>
          </div>
          <div class="flex items-center space-x-4">
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="select-all" class="rounded">
              <span class="text-sm text-text-secondary">Select All</span>
            </label>
            <span class="text-sm text-text-secondary" id="selection-count">0 selected</span>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="transaction-table w-full">
            <thead>
              <tr>
                <th class="w-12"></th>
                <th>Year</th>
                <th>Month</th>
                <th class="text-right">Amount</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody id="transaction-tbody">
              <!-- Transactions will be populated here -->
            </tbody>
          </table>
        </div>

        <div class="flex justify-between items-center mt-6">
          <div class="text-sm text-text-secondary">
            Selected total: <span class="font-medium text-text-primary" id="selected-total">$0.00</span>
          </div>
          <div class="flex space-x-3">
            <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
            <button class="btn btn-primary" onclick="proceedToExport()">Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Export Configuration -->
      <div id="export-section" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center space-x-3 mb-4">
          <i data-lucide="file-spreadsheet" class="h-5 w-5 text-primary-custom"></i>
          <h2 class="text-lg font-medium text-text-primary">Export to Excel</h2>
        </div>
        <p class="text-sm text-text-secondary mb-6">Configure your Excel export settings and download your selected transactions.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="bg-surface rounded-lg p-4">
              <h3 class="text-sm font-medium text-text-primary mb-3">Export Settings</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm font-medium text-text-primary block mb-1">Filename</label>
                  <input type="text" id="filename-input" value="expense-export" class="form-input" placeholder="Enter filename">
                  <p class="text-xs text-text-secondary mt-1">File will be saved as <span id="filename-preview">expense-export</span>.xlsx</p>
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <div class="bg-surface rounded-lg p-4">
              <h3 class="text-sm font-medium text-text-primary mb-3">Export Preview</h3>
              <div class="space-y-2 text-xs">
                <div class="flex justify-between">
                  <span class="text-text-secondary">Selected transactions:</span>
                  <span class="font-medium text-text-primary" id="export-count">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-text-secondary">Total amount:</span>
                  <span class="font-medium text-text-primary" id="export-total">$0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-between items-center mt-6">
          <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
          <button class="btn btn-primary" onclick="exportToExcel()">
            <i data-lucide="download" class="h-4 w-4 mr-2"></i>
            Export to Excel
          </button>
        </div>
      </div>

      <!-- Step 4: Success -->
      <div id="success-section" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="text-center">
          <i data-lucide="check-circle" class="h-16 w-16 mx-auto mb-4 text-green-500"></i>
          <h2 class="text-xl font-medium text-text-primary mb-2">Export Complete!</h2>
          <p class="text-text-secondary mb-6">Your transactions have been successfully exported to Excel.</p>
          <button class="btn btn-primary" onclick="startNew()">Start New Export</button>
        </div>
      </div>
    </main>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      let currentStep = 1;
      let transactions = [];
      let selectedTransactions = new Set();

      // File upload handling
      const fileUploadArea = document.getElementById('file-upload-area');
      const fileInput = document.getElementById('file-input');

      fileUploadArea.addEventListener('click', () => {
        fileInput.click();
      });

      fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
      });

      fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
      });

      fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });

      function handleFile(file) {
        if (file.name.toLowerCase().endsWith('.csv')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const csv = e.target.result;
            parseCSV(csv);
            goToStep(2);
          };
          reader.readAsText(file);
        } else {
          alert('Please upload a CSV file for this demo version.');
        }
      }

      function parseCSV(csv) {
        const lines = csv.split('\n');
        const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
        
        // Find column indices
        let dateIndex = headers.findIndex(h => h.includes('date'));
        let descIndex = headers.findIndex(h => h.includes('description') || h.includes('merchant') || h.includes('desc'));
        let amountIndex = headers.findIndex(h => h.includes('amount') || h.includes('debit') || h.includes('credit'));
        
        // Fallback to positional if headers not found
        if (dateIndex === -1) dateIndex = 0;
        if (descIndex === -1) descIndex = 1;
        if (amountIndex === -1) amountIndex = 2;
        
        transactions = [];
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim()) {
            // Handle CSV with quotes and commas inside fields
            const values = parseCSVLine(lines[i]);
            if (values.length >= 3) {
              const dateStr = values[dateIndex] || '';
              const description = values[descIndex] || 'Unknown Transaction';
              const amountStr = values[amountIndex] || '0';
              
              // Parse date more flexibly
              let date = new Date(dateStr);
              if (isNaN(date.getTime())) {
                // Try parsing MM/DD/YYYY format
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                  date = new Date(parts[2], parts[0] - 1, parts[1]);
                }
              }
              
              // Parse amount more flexibly
              let amount = 0;
              const cleanAmount = amountStr.replace(/[$,\s]/g, '');
              
              // Parse amounts based on original CSV sign
              // Positive in CSV = Income (display as negative)
              // Negative in CSV = Expense (display as positive)
              
              if (amountStr.includes('(') && amountStr.includes(')')) {
                // Parentheses indicate negative (expense) - display as positive
                amount = Math.abs(parseFloat(cleanAmount.replace(/[()]/g, '')) || 0);
              } else if (cleanAmount.startsWith('-')) {
                // Negative sign indicates expense - display as positive
                amount = Math.abs(parseFloat(cleanAmount) || 0);
              } else {
                // Positive in CSV indicates income - display as negative
                amount = -(parseFloat(cleanAmount) || 0);
              }
              
              if (!isNaN(date.getTime())) {
                transactions.push({
                  id: i,
                  date: date,
                  year: date.getFullYear(),
                  month: date.toLocaleDateString('en-US', { month: 'long' }),
                  description: description.trim(),
                  amount: amount
                });
              }
            }
          }
        }
        
        console.log(`Parsed ${transactions.length} transactions`);
        displayTransactions();
      }
      
      function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        result.push(current.trim());
        return result.map(v => v.replace(/^"|"$/g, ''));
      }

      function displayTransactions() {
        const tbody = document.getElementById('transaction-tbody');
        tbody.innerHTML = '';
        
        transactions.forEach(transaction => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <input type="checkbox" class="transaction-checkbox" data-id="${transaction.id}" onchange="updateSelection()">
            </td>
            <td class="text-text-primary">${transaction.year}</td>
            <td class="text-text-primary">${transaction.month}</td>
            <td class="text-right font-medium text-text-primary">$${transaction.amount.toFixed(2)}</td>
            <td class="text-text-primary">${transaction.description}</td>
          `;
          tbody.appendChild(row);
        });
        
        updateSelection();
      }

      function updateSelection() {
        const checkboxes = document.querySelectorAll('.transaction-checkbox');
        selectedTransactions.clear();
        let total = 0;
        
        checkboxes.forEach(cb => {
          if (cb.checked) {
            const id = parseInt(cb.dataset.id);
            selectedTransactions.add(id);
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
              total += transaction.amount;
            }
          }
        });
        
        document.getElementById('selection-count').textContent = `${selectedTransactions.size} selected`;
        document.getElementById('selected-total').textContent = `$${total.toFixed(2)}`;
        
        // Update select all checkbox
        const selectAll = document.getElementById('select-all');
        selectAll.checked = selectedTransactions.size === transactions.length;
        selectAll.indeterminate = selectedTransactions.size > 0 && selectedTransactions.size < transactions.length;
      }

      document.getElementById('select-all').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.transaction-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
        });
        updateSelection();
      });

      document.getElementById('filename-input').addEventListener('input', (e) => {
        document.getElementById('filename-preview').textContent = e.target.value || 'filename';
      });

      function goToStep(step) {
        // Hide all sections
        document.querySelectorAll('#upload-section, #transaction-section, #export-section, #success-section').forEach(section => {
          section.classList.add('hidden');
        });
        
        // Update step indicators
        document.querySelectorAll('.step').forEach((stepEl, index) => {
          if (index + 1 <= step) {
            stepEl.classList.add('active');
          } else {
            stepEl.classList.remove('active');
          }
        });
        
        // Show current section
        currentStep = step;
        switch (step) {
          case 1:
            document.getElementById('upload-section').classList.remove('hidden');
            break;
          case 2:
            document.getElementById('transaction-section').classList.remove('hidden');
            break;
          case 3:
            document.getElementById('export-section').classList.remove('hidden');
            updateExportPreview();
            break;
          case 4:
            document.getElementById('success-section').classList.remove('hidden');
            break;
        }
      }

      function proceedToExport() {
        if (selectedTransactions.size === 0) {
          alert('Please select at least one transaction to continue.');
          return;
        }
        goToStep(3);
      }

      function updateExportPreview() {
        const total = Array.from(selectedTransactions).reduce((sum, id) => {
          const transaction = transactions.find(t => t.id === id);
          return sum + (transaction ? transaction.amount : 0);
        }, 0);
        
        document.getElementById('export-count').textContent = selectedTransactions.size;
        document.getElementById('export-total').textContent = `$${total.toFixed(2)}`;
      }

      function exportToExcel() {
        const filename = document.getElementById('filename-input').value || 'expense-export';
        
        // Get selected transaction data
        const selectedData = Array.from(selectedTransactions).map(id => {
          const transaction = transactions.find(t => t.id === id);
          return {
            Year: transaction.year,
            Month: transaction.month,
            Amount: transaction.amount, // Keep original sign
            Description: transaction.description
          };
        });
        
        // Create CSV content with proper line breaks
        let csvContent = 'Year,Month,Amount,Description\r\n';
        selectedData.forEach(row => {
          // Escape quotes in description and wrap in quotes if contains comma
          const description = row.Description.replace(/"/g, '""');
          const needsQuotes = description.includes(',') || description.includes('\n') || description.includes('\r');
          const formattedDescription = needsQuotes ? `"${description}"` : description;
          
          csvContent += `${row.Year},${row.Month},${row.Amount.toFixed(2)},${formattedDescription}\r\n`;
        });
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.csv`;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        goToStep(4);
      }

      function startNew() {
        transactions = [];
        selectedTransactions.clear();
        document.getElementById('filename-input').value = 'expense-export';
        document.getElementById('filename-preview').textContent = 'expense-export';
        fileInput.value = '';
        goToStep(1);
      }

      // Initialize
      goToStep(1);
    </script>
  </body>
</html>